pipeline {
    agent any
    environment {
        
        //environment variables
        REGISTRY_URI = 'us.gcr.io'
        PROJECT_ID = 'airqo-250220'
        IMAGE_NAME_PROD = 'airqo-test-api'
        IMAGE_NAME_STAGE = 'airqo-stage-test-api'
        K8S_CONFIG = 'airqo-k8s-config'
        }
    stages {
        stage("Checkout code") {
            steps {
                checkout scm
            }
        }
        stage("Build"){
                 steps {

                    echo "Docker Build"
                    sh """
                    docker build -t ${REGISTRY_URI}/${PROJECT_ID}/$IMAGE_NAME_STAGE:"latest" . 
                    """
                    echo "Docker Push"
                    sh """
                        docker push ${REGISTRY_URI}/${PROJECT_ID}/$IMAGE_NAME_STAGE:"latest"
                    """
                    }
                    post{
                        success{
                            echo "Build and Push Successfully"
                            }
                        failure{
                            echo "Build and Push Failed"
                            }
                    }

                }
        
        stage("Deploy to Staging"){
                steps {
                    sh """
                    kubectl delete -f 'devops/microservice-1/stage-test-cicd.yaml'
                    kubectl apply -f ''devops/microservice-1/stage-test-cicd.yaml''
                    """
                }
                post{
                    success{
                        echo "Successfully deployed to staging"
                    }
                    failure{
                        echo "Failed deploying to staging"
                    }
                }
            }
            stage('Final') {
                steps {
                    //webhook for your notification channel 
                    echo 'Service deployed successfully'
                }
            }
    }    
}